{% extends 'base.html' %}
{% load static %}

{% block head %}
  {{ block.super }}
  <script>
    var iosDragDropShim = { enableEnterLeave: true }
  </script>
  <script src="{% static "js/ios-drag-drop.js" %}"></script>
  <style type="text/css">
    #wastes {
      margin-left:auto;
      margin-right:auto;
      text-align: center;
    }
    #wastes > div {
      display:inline-block;
      vertical-align: top;
    }
    .waste {
      width:60px;
      height: 85px;
      text-align: center;
      border: 1px solid #aaa;
      border-radius: 5px;
      cursor: pointer;
      margin:3px;
      font-size: 0.6em
    }
    .waste:hover {
      background-color: #ddd;
      border:1px solid #888;
    }
    .waste img {
      width:50px;
      height: 50px;
    }
    #dustbins {
      margin-left:auto;
      margin-right:auto;
      text-align: center;
    }
    #dustbins > div {
      display:inline-block;
      vertical-align: top;
    }
    .dustbin {
      width:66px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }
    .dustbin img {
      width:60px;
    }
    #insee {
      width: 100%;
    }
  </style>
{% endblock head %}

{% block body %}
  <div class="row">

    <div class="col-md-7">
      <h5>De quelles couleurs sont les poubelles dans votre commune ?</h5>
      <br>

  <form action="{% url 'contribuer' %}" method="post" id="contribution-form">

<label for="insee"><strong>Glissez les déchets dans les bonnes poubelles !</strong></label>
<p id="passwordHelpBlock" class="form-text text-muted">
  En cas de doute, mettez le déchet dans la poubelle "je ne sais pas".
</p>

  <div ondrop="drop_handler(event);" ondragover="dragover_handler(event);" id="wastes">
      {% for waste in wastes %}
      <div draggable="true" class="waste" ondragstart="dragstart_handler(event);" id="waste-{{ waste.id }}" data-waste="{{ waste.id }}">
        <img class="card-img-top" draggable="false" src="{{ waste.image.url }}" alt="{{ waste.name }}">
        {{ waste.name|title }}
      </div>
      {% endfor %}
      <div style="clear: both"></div>
  </div>

  <div style="font-size: 2.5em; font-weight: bold;text-align: center;">⇓</div>

  <div id="dustbins">
      {% for dustbin in dustbins %}
        <div class="dustbin" ondragover="dragover_handler(event);" ondrop="drop_handler(event);" data-dustbin="{{ dustbin.id }}">
          <img class="card-img-top" draggable="false"  src="{{ dustbin.image.url }}" alt="{{ dustbin.name }}">
          <span style="font-size: 0.6em">{{ dustbin.name|title }}</span>
          <div class="drop-zone"></div>
        </div>
      {% endfor %}
  </div>


    {% csrf_token %}
    {{ form.as_p }}
    <div class="form-group">
      <label for="insee"><strong>Indiquez le code postal de votre commune</strong></label>
      <br>
      <select id="insee" class="form-control"></select>
    </div>

    <button type="submit" class="btn btn-primary btn-block">Contribuer</button>
    <br>
    <div class="alert alert-success">
        <p>Votre contribution est anonyme.
    <br>
    Les données collectées ont vocation à être ouvertes dans un objectif de création de bien commun.
    </p>
    </div>
  </form>

    </div>
    <div class="col-md-5">

  <div id="mapArea" class="blackboard" style="width: 500px;border: 1px solid #c0c0c0;">
    <svg id="map" xmlns="http://www.w3.org/2000/svg" width="100%" x="0" y="0"></svg>
  </div>

    </div>
  </div>

{% endblock body %}

{% block bottom %}
  {{ block.super }}

  <script type="text/javascript">
    /* geojson2svg client side converter */
    !function(){function e(e){var t=document.createElementNS("http://www.w3.org/1999/xhtml","div");t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg">'+e+"</svg>";for(var n=document.createDocumentFragment();t.firstChild.firstChild;)n.appendChild(t.firstChild.firstChild);return n}"undefined"!=typeof module&&module.exports&&(module.exports=e),"undefined"!=typeof window&&(window.parseSVG=e)}();
  </script>

  <script type="text/javascript">

  /* form submission */
  $("#contribution-form").submit(function(event){
    data = {};
    $('#id_insee').val($('#insee').val());
    $('#dustbins').children().each(function(i){
      var key = $(this).data().dustbin
      data[key] = [];
      $(this).find('.waste').each(function(j){
        data[key].push($(this).data().waste);
      })
    })
    $('#id_trashes').val(JSON.stringify(data))
  });

  /* drag and drop handlers */
  function dragstart_handler(ev) {
    ev.dataTransfer.setData("text/plain", ev.target.id);
  }
  function dragover_handler(ev) {
    ev.preventDefault();
    ev.dataTransfer.dropEffect = "move";
    return false;
  }
  function drop_handler(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    var dropZone = $(ev.target).closest(".dustbin").find(".drop-zone")
    if(dropZone.length > 0){
      dropZone.append(document.getElementById(data));
    }else{
      $('#wastes').prepend(document.getElementById(data));
    }
    return false;
  }

  /* geojson svg */
  /*
  var l =  -4.766667,
    r = 8.245,
    b = 42.32944,
    t = 51.09639;

  var ratio = (t-b)/(-1*l+r);

  var container = document.getElementById('mapArea'),
    width = container.offsetWidth,
    svgMap = document.getElementById('map');
    svgMap.setAttribute('width', width);
    svgMap.setAttribute('height', width*ratio);

  var converter = geojson2svg(
    {
      viewportExtent: {width: width, height: width},
      attributes: {'style': 'stroke:#000000; fill: #cc99aa;stroke-width:1px;'},
      mapExtent: {left: l, right: r, bottom: b, top: t}
    }
  );

  var geojson = {{ geojson|safe }};
  for(var i=0; i< geojson.features.length; i++){
    var svgString = converter.convert(geojson.features[i].geometry);
    var svg = parseSVG(svgString);
    svgMap.appendChild(svg);
  };
  */
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>

  <script type="text/javascript">
    $('#insee').select2({
      selectOnClose: true,
      multiple:false,
      minimumInputLength: 5,
      ajax:{
        url: 'https://geo.api.gouv.fr/communes',
        dataType: 'json',
        delay: 250,
        data: function (params) {
          return {
            codePostal: params.term
          };
        },
        processResults: function (data, params) {
          return {
            results: data.map(function(item) {
              return {
                id : item.code,
                text : item.codesPostaux+' '+item.nom
              };
            })
          };
        },
        cache: true
        },
        escapeMarkup: function (markup) { return markup; }
    });
  </script>
{% endblock bottom %}
